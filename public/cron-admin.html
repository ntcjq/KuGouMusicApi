<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>定时签到管理 - 酷狗音乐 API</title>
  </head>

  <body>
    <div id="admin-container">
      <div id="logins-section">
        <h2>已保存的登录账户</h2>
        <button onclick="addUserManually()" style="background-color: #ff9800;">添加用户</button>
        <button onclick="refreshLogins()">刷新列表</button>
        <button onclick="clearAllLogins()" style="background-color: #ff6b6b;">清空所有</button>
        <button onclick="clearCache()" style="background-color: #f39c12;">清除缓存</button>
        <div id="logins-list"></div>
      </div>

      <div id="cron-section" style="margin-top: 40px;">
        <h2>定时任务配置</h2>
        <div id="cron-config">
          <label>选择账户:</label>
          <select id="userid-select"></select>
          
          <label style="margin-left: 20px;">执行时间 (Cron表达式):</label>
          <input type="text" id="cron-time" value="0 2 * * *" placeholder="默认每天凌晨2点" style="width: 200px; padding: 8px;">
          <small style="display: block; margin: 5px 0;">Cron格式: 分 时 日 月 周 (例: 0 2 * * * = 每天02:00)</small>
          
          <button onclick="startCron()" style="margin-top: 10px;">启动定时签到</button>
        </div>

        <h2>任务状态</h2>
        <button onclick="refreshCronStatus()">刷新状态</button>
        <div id="cron-status"></div>
      </div>
    </div>

    <div id="add-user-modal">
      <div class="modal-content">
        <h2>添加用户</h2>
        <p>请粘贴登录成功后返回的完整 JSON 数据</p>
        <textarea id="json-input" placeholder='粘贴登录返回的JSON数据，例如:
{
    "data": {
        "userid": 2460643656,
        "token": "64d52aa2f937f11ef54d4101c2b1c963e57441aac239f988d818dd019352f401",
        ...
    },
    "status": 1
}'></textarea>
        <div class="modal-buttons">
          <button class="confirm" onclick="confirmAddUser()">确认添加</button>
          <button class="cancel" onclick="closeAddUserModal()">取消</button>
        </div>
      </div>
    </div>

    <style>
      html,
      body {
        height: 100vh;
        width: 100vw;
        margin: 0;
        padding: 0;
        background: #ffffff;
        text-align: center;
        overflow: auto;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      }

      * {
        color: rgb(100, 100, 100);
      }

      a {
        color: #42b983;
      }

      #admin-container {
        margin: 20px auto;
        padding: 30px 20px;
        max-width: 100%;
        height: 100%;
        overflow: auto;
        text-align: left;
      }

      h2 {
        margin: 20px 0 15px 0;
        border-bottom: 2px solid #667eea;
        padding-bottom: 10px;
        font-size: 16px;
        font-weight: 600;
        color: #333;
      }

      button {
        padding: 10px 18px;
        font-size: 14px;
        font-weight: 500;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 6px;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
      }

      button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      button:disabled {
        background: #ccc;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
      }

      button[style*="#ff9800"],
      button[style*="#ff6b6b"],
      button[style*="#f39c12"] {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3) !important;
      }

      #logins-list {
        background-color: #f9f9f9;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
        max-height: 250px;
        overflow-y: auto;
      }

      .login-item {
        background: white;
        padding: 12px;
        margin: 8px 0;
        border-radius: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-left: 4px solid #667eea;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
      }

      .login-info {
        flex: 1;
      }

      .login-info p {
        margin: 4px 0;
        font-size: 13px;
      }

      .login-item button {
        padding: 6px 12px;
        font-size: 12px;
        margin: 0 5px;
      }

      .login-item button.delete {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }

      .login-item button.delete:hover {
        box-shadow: 0 4px 12px rgba(245, 87, 108, 0.4);
      }

      select,
      input {
        padding: 10px 12px;
        font-size: 14px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        margin: 6px;
        transition: all 0.3s ease;
      }

      select:focus,
      input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      #cron-config label {
        display: inline-block;
        margin: 10px 0;
        font-weight: 500;
        color: #333;
      }

      #cron-status {
        background-color: #f9f9f9;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
        max-height: 250px;
        overflow-y: auto;
      }

      .cron-item {
        background: white;
        padding: 12px;
        margin: 8px 0;
        border-radius: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
      }

      .status-running {
        color: #4caf50;
        font-weight: bold;
        font-size: 13px;
      }

      .status-stopped {
        color: #f44336;
        font-size: 13px;
      }

      .cron-item button {
        margin: 0 5px;
      }

      .cron-item button.manual {
        background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
      }

      .cron-item button.manual:hover {
        box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
      }

      small {
        color: #999;
        font-size: 12px;
      }

      #add-user-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      #add-user-modal.show {
        display: flex;
      }

      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 12px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      .modal-content h2 {
        margin-top: 0;
        border-bottom: 2px solid #667eea;
      }

      .modal-content textarea {
        width: 100%;
        height: 300px;
        padding: 12px;
        font-family: 'Monaco', 'Courier New', monospace;
        font-size: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        margin: 15px 0;
        box-sizing: border-box;
        transition: all 0.3s ease;
      }

      .modal-content textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .modal-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }

      .modal-buttons button {
        padding: 10px 20px;
        font-size: 14px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        color: white;
      }

      .modal-buttons .confirm {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .modal-buttons .confirm:hover {
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        transform: translateY(-2px);
      }

      .modal-buttons .cancel {
        background: linear-gradient(135deg, #999 0%, #777 100%);
      }

      .modal-buttons .cancel:hover {
        box-shadow: 0 4px 12px rgba(100, 100, 100, 0.4);
        transform: translateY(-2px);
      }
    </style>

    <script>
      async function refreshLogins() {
        try {
          const res = await fetch('/api/getLogins');
          const result = await res.json();
          
          if (result.status === 1) {
            const loginsList = document.getElementById('logins-list');
            const userSelect = document.getElementById('userid-select');
            
            if (result.data.length === 0) {
              loginsList.innerHTML = '<p style="text-align: center; color: #999;">暂无已保存的登录账户</p>';
              userSelect.innerHTML = '<option>暂无账户</option>';
              return;
            }

            loginsList.innerHTML = result.data.map(item => `
              <div class="login-item">
                <div class="login-info">
                  <p><strong>用户ID:</strong> ${item.userid}</p>
                  <p><strong>保存时间:</strong> ${new Date(item.savedAt).toLocaleString('zh-CN')}</p>
                  <p><strong>VIP到期:</strong> <span id="vip-${item.userid}">加载中...</span></p>
                </div>
                <div>
                  <button class="manual" onclick="manualCheckIn('${item.userid}')">手动签到</button>
                  <button class="delete" onclick="deleteLogin('${item.userid}')">删除</button>
                </div>
              </div>
            `).join('');

            // 异步获取每个用户的VIP到期时间并更新UI
            result.data.forEach(async (item) => {
              const el = document.getElementById(`vip-${item.userid}`);
              if (!el) return;

              try {
                const vipRes = await fetch(`/user/vip/detail?timestrap=${Date.now()}`, {
                  headers: { 'Cookie': `token=${item.token}; userid=${item.userid}` }
                });
                const vip = await vipRes.json();

                if (vip && vip.status === 1 && vip.data && vip.data.busi_vip && vip.data.busi_vip[0] && vip.data.busi_vip[0].vip_end_time) {
                  // 显示为本地时间
                  const dt = new Date(vip.data.busi_vip[0].vip_end_time);
                  el.textContent = isNaN(dt.getTime()) ? vip.data.busi_vip[0].vip_end_time : dt.toLocaleString('zh-CN');
                } else if (vip && vip.error_code === 400) {
                  el.textContent = '未开通';
                } else if (vip && vip.status === 0) {
                  el.textContent = '无数据';
                } else {
                  el.textContent = '无法获取';
                }
              } catch (error) {
                el.textContent = '请求失败';
                console.error(`获取用户 ${item.userid} VIP 到期失败:`, error);
              }
            });

            userSelect.innerHTML = result.data.map(item => 
              `<option value="${item.userid}">用户 ${item.userid}</option>`
            ).join('');
          }
        } catch (error) {
          console.error('获取登录列表失败:', error);
          alert('获取登录列表失败: ' + error.message);
        }
      }

      async function deleteLogin(userid) {
        if (!confirm(`确定要删除用户 ${userid} 的登录信息吗？`)) {
          return;
        }

        try {
          const res = await fetch('/api/deleteLogin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userid })
          });
          const result = await res.json();
          
          if (result.status === 1) {
            alert('删除成功');
            refreshLogins();
          } else {
            alert('删除失败: ' + result.msg);
          }
        } catch (error) {
          alert('请求失败: ' + error.message);
        }
      }

      async function clearAllLogins() {
        if (!confirm('确定要清空所有登录信息吗？这个操作无法撤销！')) {
          return;
        }

        try {
          const res = await fetch('/api/clearLogins', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          const result = await res.json();
          
          if (result.status === 1) {
            alert('已清空所有登录信息');
            refreshLogins();
            refreshCronStatus();
          } else {
            alert('清空失败: ' + result.msg);
          }
        } catch (error) {
          alert('请求失败: ' + error.message);
        }
      }

      async function startCron() {
        const userid = document.getElementById('userid-select').value;
        const cronTime = document.getElementById('cron-time').value;

        if (!userid || userid === '暂无账户') {
          alert('请先选择一个账户');
          return;
        }

        if (!cronTime) {
          alert('请输入Cron表达式');
          return;
        }

        try {
          const res = await fetch('/api/startAutoCron', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userid, time: cronTime })
          });
          const result = await res.json();
          
          if (result.status === 1) {
            alert(result.msg);
            refreshCronStatus();
          } else {
            alert('启动失败: ' + result.msg);
          }
        } catch (error) {
          alert('请求失败: ' + error.message);
        }
      }

      async function stopCron(userid) {
        if (!confirm(`确定要停止用户 ${userid} 的定时签到任务吗？`)) {
          return;
        }

        try {
          const res = await fetch('/api/stopAutoCron', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userid })
          });
          const result = await res.json();
          
          if (result.status === 1) {
            alert('已停止');
            refreshCronStatus();
          } else {
            alert('停止失败: ' + result.msg);
          }
        } catch (error) {
          alert('请求失败: ' + error.message);
        }
      }

      async function manualCheckIn(userid) {
        if (!confirm(`确定要为用户 ${userid} 手动签到吗？`)) {
          return;
        }

        const btn = event.target;
        btn.disabled = true;
        btn.textContent = '签到中...';

        try {
          // 首先从服务端获取用户的token和userid
          const loginRes = await fetch('/api/getLogins');
          const loginResult = await loginRes.json();
          
          console.log('获取的登录信息:', loginResult);
          console.log('查找的userid:', userid, '类型:', typeof userid);
          
          let userToken = null;
          let actualUserid = null;
          
          if (loginResult.status === 1 && loginResult.data && loginResult.data.length > 0) {
            console.log('所有登录信息:', loginResult.data);
            // 对比时转换为字符串，防止类型不匹配
            const userLogin = loginResult.data.find(item => String(item.userid) === String(userid));
            console.log('查找结果:', userLogin);
            
            if (userLogin) {
              userToken = userLogin.token;
              actualUserid = userLogin.userid;
              console.log('获取的token:', userToken ? 'OK' : 'FAIL');
              console.log('获取的userid:', actualUserid);
            }
          } else {
            console.log('登录信息为空或请求失败');
          }

          if (!userToken || !actualUserid) {
            alert(`无法获取用户登录信息\n请检查浏览器控制台了解详情\nUserid: ${userid}`);
            console.error('详细信息 - Status:', loginResult.status, 'Data:', loginResult.data, 'Token:', userToken, 'Userid:', actualUserid);
            btn.disabled = false;
            btn.textContent = '手动签到';
            return;
          }

          // 获取用户信息验证
          let userRes = await fetch(`/user/detail?timestrap=${Date.now()}`, {
            headers: { 'Cookie': `token=${userToken}; userid=${actualUserid}` }
          });
          let userDetail = await userRes.json();

          if (!userDetail?.data?.nickname) {
            alert('token过期或账号不存在，请重新登录');
            btn.disabled = false;
            btn.textContent = '手动签到';
            return;
          }

          console.log(`手动签到: 用户 ${userDetail.data.nickname}`);

          // 听歌领取VIP
          let listenRes = await fetch(`/youth/listen/song?timestrap=${Date.now()}`, {
            headers: { 'Cookie': `token=${userToken}; userid=${actualUserid}` }
          });
          let listen = await listenRes.json();

          if (listen.status === 1) {
            console.log('听歌领取成功');
          } else if (listen.error_code === 130012) {
            console.log('听歌：今日已领取');
          } else {
            console.log('听歌领取失败');
          }

          // 领取VIP（循环8次）
          let successCount = 0;
          for (let i = 1; i <= 8; i++) {
            let adRes = await fetch(`/youth/vip?timestrap=${Date.now()}`, {
              headers: { 'Cookie': `token=${userToken}; userid=${actualUserid}` }
            });
            let ad = await adRes.json();

            if (ad.status === 1) {
              console.log(`第${i}次领取成功`);
              successCount++;
              if (i !== 8) {
                const randomDelay = 30000 + Math.random() * 10000; // 随机30-40秒
                console.log(`等待${(randomDelay/1000).toFixed(1)}秒后继续...`);
                await new Promise(resolve => setTimeout(resolve, randomDelay));
              }
            } else if (ad.error_code === 30002) {
              console.log('今日次数已用光');
              break;
            } else {
              console.log(`第${i}次领取失败`);
              break;
            }
          }

          // 获取VIP详情
          let vipRes = await fetch(`/user/vip/detail?timestrap=${Date.now()}`, {
            headers: { 'Cookie': `token=${userToken}; userid=${actualUserid}` }
          });
          let vip = await vipRes.json();

          if (vip.status === 1) {
            alert(`签到成功！\n领取${successCount}次VIP\nVIP到期时间：${vip.data.busi_vip[0].vip_end_time}`);
          } else {
            alert(`签到完成！领取${successCount}次VIP`);
          }

          refreshCronStatus();
        } catch (error) {
          alert('请求失败: ' + error.message);
          console.error('手动签到出错:', error);
        } finally {
          btn.disabled = false;
          btn.textContent = '手动签到';
        }
      }

      async function refreshCronStatus() {
        try {
          const res = await fetch('/api/getCronStatus');
          const result = await res.json();
          
          const statusDiv = document.getElementById('cron-status');
          
          if (!result.data || Object.keys(result.data).length === 0) {
            statusDiv.innerHTML = '<p style="text-align: center; color: #999;">暂无定时任务</p>';
            return;
          }

          statusDiv.innerHTML = Object.entries(result.data).map(([userid, status]) => {
            const isRunning = status === '运行中';
            return `
              <div class="cron-item">
                <div>
                  <p><strong>用户ID:</strong> ${userid}</p>
                  <p><strong>状态:</strong> <span class="${isRunning ? 'status-running' : 'status-stopped'}">${status}</span></p>
                </div>
                <div>
                  <button class="manual" onclick="manualCheckIn('${userid}')">手动签到</button>
                  <button onclick="stopCron('${userid}')" ${!isRunning ? 'disabled' : ''}>停止任务</button>
                </div>
              </div>
            `;
          }).join('');
        } catch (error) {
          console.error('获取任务状态失败:', error);
        }
      }

      // 页面加载时初始化
      window.addEventListener('load', () => {
        refreshLogins();
        refreshCronStatus();
        // 每30秒刷新一次状态
        setInterval(refreshCronStatus, 30000);

        // 监听其他页面保存登录后的通知（跨标签刷新）
        window.addEventListener('storage', (e) => {
          if (e.key === 'loginsUpdated') {
            console.log('[Storage] 检测到登录信息更新，刷新列表');
            refreshLogins();
            refreshCronStatus();
          }
        });
      });

      // 手动清除服务器缓存（会清空 apicache 的内容）
      async function clearCache() {
        if (!confirm('确定要清除服务器缓存吗？这会清空所有 apicache 条目。')) return;
        try {
          const res = await fetch('/api/clearCache', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
          const result = await res.json();
          if (result.status === 1) {
            alert('缓存已清除');
            console.log('[Cache] clear result:', result);
            // 立刻刷新显示
            refreshLogins();
            refreshCronStatus();
          } else {
            alert('清除缓存失败: ' + (result.msg || '未知错误'));
          }
        } catch (err) {
          console.error('清除缓存失败:', err);
          alert('请求失败: ' + err.message);
        }
      }

      function addUserManually() {
        const modal = document.getElementById('add-user-modal');
        modal.classList.add('show');
        document.getElementById('json-input').value = '';
        document.getElementById('json-input').focus();
      }

      function closeAddUserModal() {
        const modal = document.getElementById('add-user-modal');
        modal.classList.remove('show');
      }

      async function confirmAddUser() {
        const jsonInput = document.getElementById('json-input').value.trim();

        if (!jsonInput) {
          alert('请粘贴JSON数据');
          return;
        }

        try {
          const data = JSON.parse(jsonInput);

          // 验证JSON结构
          if (!data.data || !data.data.userid || !data.data.token) {
            alert('JSON格式错误，必须包含 data.userid 和 data.token');
            return;
          }

          const userid = data.data.userid;
          const token = data.data.token;
          const nickname = data.data.nickname || userid;

          console.log(`添加用户 - userid: ${userid}, nickname: ${nickname}`);

          // 保存到服务器（测量耗时以排查延迟）
          const t0 = performance.now();
          const saveRes = await fetch('/api/saveLogin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userid, token })
          });
          const t1 = performance.now();
          const serverMs = saveRes.headers.get('X-Elapsed-Ms');
          const saveResult = await saveRes.json();

          if (saveResult.status === 1) {
            alert(`✓ 用户 ${nickname} 添加成功 (client: ${(t1-t0).toFixed(1)}ms, server: ${serverMs}ms)`);
            closeAddUserModal();
            refreshLogins();
            refreshCronStatus();
          } else {
            alert('保存失败: ' + saveResult.msg);
          }
        } catch (error) {
          alert('JSON解析错误: ' + error.message);
          console.error('详细错误:', error);
        }
      }

      // 按Escape关闭模态框
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeAddUserModal();
        }
      });

      // 点击外部关闭模态框
      document.getElementById('add-user-modal').addEventListener('click', (e) => {
        if (e.target.id === 'add-user-modal') {
          closeAddUserModal();
        }
      });
    </script>
  </body>
</html>
